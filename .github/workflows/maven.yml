name: CI\CD v101
on:
  push:
    branches: ["main", "testSolution"]
  pull_request:
    branches: ["main", "testSolution"]
    types: [opened, synchronize]
  workflow_call:
permissions:
  checks: write
  actions: write
  contents: write
  pull-requests: write
  pages: write
  id-token: write
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    if: github.actor != 'github-classroom[bot]' && (github.event_name != 'push' || github.event.pull_request == null)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get Latest SHA
        id: get_sha
        run: |
          LATEST_SHA=$(git log -1 --format="%H" --all -- . ':(glob)**/*.java' ':(exclude)**/*Tester.java' 2>/dev/null || git rev-parse HEAD)
          echo "sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          echo "Latest SHA: $LATEST_SHA"
      - name: Configure Git merge strategy
        run: |
          git config --global merge.ours.driver true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Install Checkstyle
        run: |
          curl -L -o checkstyle.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.20.0/checkstyle-10.20.0-all.jar

      - name: Run Checkstyle
        run: |
          java -jar checkstyle.jar \
            -c .github/google_checks.xml \
            -f xml \
            -o checkstyle-result.xml \
            $(git ls-files '*.java' | grep -v 'Tester\.java$')

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1

      - name: Report with reviewdog
        id: reviewdog
        run: |
          reviewdog -name="checkstyle" \
            -reporter=github-check \
            -filter-mode=nofilter \
            -level=error \
            -fail-level=any \
            -f=checkstyle < checkstyle-result.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_SHA: ${{ steps.get_sha.outputs.sha }}

      - name: Build with Maven
        if: steps.reviewdog.outcome == 'success'
        run: mvn -B package --file pom.xml -Dcheckstyle.skip=true
      - name: Calculate Grade
        if: always()
        id: grade
        run: |
          # Parse test results from Maven Surefire XML reports
          if [ -d "target/surefire-reports" ]; then
            TESTS=$(grep -r "tests=" target/surefire-reports/TEST-*.xml | sed -n 's/.*tests="\([0-9]*\)".*/\1/p' | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -r "failures=" target/surefire-reports/TEST-*.xml | sed -n 's/.*failures="\([0-9]*\)".*/\1/p' | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -r "errors=" target/surefire-reports/TEST-*.xml | sed -n 's/.*errors="\([0-9]*\)".*/\1/p' | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -r "skipped=" target/surefire-reports/TEST-*.xml | sed -n 's/.*skipped="\([0-9]*\)".*/\1/p' | awk '{s+=$1} END {print s}')
            
            # Default to 0 if values are empty
            TESTS=${TESTS:-0}
            FAILURES=${FAILURES:-0}
            ERRORS=${ERRORS:-0}
            SKIPPED=${SKIPPED:-0}
            
            # Calculate passed tests
            PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))
            
            # Calculate grade (percentage)
            if [ $TESTS -gt 0 ]; then
              GRADE=$((PASSED * 100 / TESTS))

              if [ "${{ steps.reviewdog.outcome }}" = "failure" ]; then
                GRADE=$((GRADE - 25))
              fi
              
            else
              GRADE=0
            fi
            
            echo "Total Tests: $TESTS"
            echo "Passed: $PASSED"
            echo "Failed: $FAILURES"
            echo "Errors: $ERRORS"
            echo "Skipped: $SKIPPED"
            echo "Grade: ${GRADE}%"
            
            # Set outputs for other steps
            echo "tests=$TESTS" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILURES" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            echo "grade=$GRADE" >> $GITHUB_OUTPUT
          else
            echo "No test results found"
            echo "tests=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "grade=0" >> $GITHUB_OUTPUT
          fi
      - name: Create Grade Badge
        if: always()
        run: |
          mkdir -p .github/badges
          GRADE="${{ steps.grade.outputs.grade }}"
          if [ $GRADE -ge 90 ]; then
            COLOR="brightgreen"
          elif [ $GRADE -ge 70 ]; then
            COLOR="green"
          elif [ $GRADE -ge 50 ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          # Create badge with link to GitHub Actions run
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          RUN_ID="${{ github.run_id }}"
          TEST_REPORT_URL="https://github.com/${OWNER}/${REPO_NAME}/actions/runs/${RUN_ID}"
          echo "[![Grade](https://img.shields.io/badge/Grade-${GRADE}%25-${COLOR})](${TEST_REPORT_URL})" > .github/badges/grade.md
          echo "[ðŸ“Š View Test Reports](${TEST_REPORT_URL})" > .github/badges/test_report.md
      - name: Publish Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Maven Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      # Collect all Java files (excluding *Tester.java)
      - name: Collect Java files
        if: always()
        run: |
          find . -name "Hotel*.java" -not -name "*Tester.java" -type f > java_files.txt
      # Run AI Review with ChatGPT
      - name: AI Review with ChatGPT
        if: always() && steps.grade.outputs.grade > 0 && steps.reviewdog.outcome == 'success'
        id: ai_review
        run: |
          mkdir -p .github/badges

          # Function to update grade badge with penalty
          update_grade_badge() {
            local ORIGINAL_GRADE=$1
            local PENALTY=$2
            local PENALTY_MESSAGE=$3
            
            ADJUSTED_GRADE=$((ORIGINAL_GRADE - PENALTY))
            if [ $ADJUSTED_GRADE -lt 0 ]; then
              ADJUSTED_GRADE=0
            fi
            
            # Determine color for adjusted grade
            if [ $ADJUSTED_GRADE -ge 90 ]; then
              COLOR="brightgreen"
            elif [ $ADJUSTED_GRADE -ge 70 ]; then
              COLOR="green"
            elif [ $ADJUSTED_GRADE -ge 50 ]; then
              COLOR="yellow"
            else
              COLOR="red"
            fi
            
            # Update grade badge
            REPO_NAME="${{ github.event.repository.name }}"
            OWNER="${{ github.repository_owner }}"
            RUN_ID="${{ github.run_id }}"
            TEST_REPORT_URL="https://github.com/${OWNER}/${REPO_NAME}/actions/runs/${RUN_ID}"
            echo "[![Grade](https://img.shields.io/badge/Grade-${ADJUSTED_GRADE}%25-${COLOR})](${TEST_REPORT_URL}) *(Original: ${ORIGINAL_GRADE}%, Penalties: -${PENALTY})${PENALTY_MESSAGE}*" > .github/badges/grade.md
            
            echo "adjusted_grade=$ADJUSTED_GRADE" >> $GITHUB_OUTPUT
          }

          # Build combined content of all Java files
          ALL_CONTENT=""
          for file in $(cat java_files.txt); do
            FILE_CONTENT=$(cat "$file")
            ALL_CONTENT="${ALL_CONTENT}--- File: $file ---\n${FILE_CONTENT}\n\n"
          done

          # Escape for JSON
          ALL_CONTENT_ESCAPED=$(echo "$ALL_CONTENT" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # Send all files in a single request with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          RESPONSE=""

          # Check if API key is set
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ ERROR: OPENAI_API_KEY secret is not configured"
            echo "Please add your OpenAI API key to GitHub repository secrets"
            RESPONSE="âš ï¸ **AI Review Unavailable** (-20 points): OpenAI API key not configured. Please add OPENAI_API_KEY to repository secrets, or ask your teacher, Barak, to add a key for you."
            echo "## AI Code Review" > .github/badges/review.md
            echo "" >> .github/badges/review.md
            echo "$RESPONSE" >> .github/badges/review.md
            
            # Apply penalty for missing AI review
            update_grade_badge "${{ steps.grade.outputs.grade }}" 20 ""
            exit 0
          fi

          # Check if grade is less than 100 - skip AI review API call
          if [ "${{ steps.grade.outputs.grade }}" -lt 100 ]; then
            echo "Grade is less than 100, skipping AI review"
            RESPONSE="âŒ **Sending to AI Review Without Perfect Tests** (-30 points): Submitting code for AI review when tests don't pass wastes your teacher's money. Barak doesn't like it. Please ensure all tests pass before requesting AI review."
            echo "## AI Code Review" > .github/badges/review.md
            echo "" >> .github/badges/review.md
            echo "$RESPONSE" >> .github/badges/review.md
            
            # Apply penalty for submitting without perfect tests
            update_grade_badge "${{ steps.grade.outputs.grade }}" 30 ""
            exit 0
          fi

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RAW_RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
              -d "{
                 \"model\": \"gpt-4o",
                    \"messages\": [
                  {\"role\": \"system\", \"content\": \"You are a senior Java code reviewer and computer science teacher reviewing student exercises at a high-school level.\\n\\nTHIS IS A LEARNING EXERCISE.\\n\\nReview the student's code and provide clear, constructive feedback.\\n\\nThe students haven't learned lambda, Inheritance.\\n\\nThe review shall be short and clear. No more than 10 lines.\\n\\nABSOLUTE RULES:\\n1) For DUPLICATE CODE: Provide the complete solution including the method signature and implementation\\n2) For OTHER ISSUES: DO NOT provide code, only explain WHAT needs to change\\n3) Keep feedback short, clear, and encouraging.\\n\\nRules:\\n- DO NOT mention or comment on parts of the code that are already correct.\\n- ONLY report real issues that require changes to the code.\\n- If the code is correct, respond that no changes are required.\\n- If you are unsure whether something is incorrect, do NOT mark it as an issue.\"},
                  {\"role\": \"user\", \"content\": \"Review the following Java file.\\n\\nFOCUS ON:\\n- Duplicate code (HIGHEST PRIORITY)\\n- Magic numbers\\n\\nDUPLICATE CODE RULES:\\n- Duplicate code applies ONLY within a SINGLE class\\n- The same or logically equivalent code appears more than once\\n- The duplicated logic must be extractable into a single method\\n- IMPORTANT: Duplicate code ONLY applies when extracting to a method REDUCES the total number of lines of code\\n- Do NOT consider extract inheritance, Lambda, or interfaces\\n- INVALID SOLUTIONS: Do NOT suggest solutions using lambda expressions, functional interfaces, array indexing patterns, or any features the students haven't learned. Examples of INVALID solutions:\\n  * Using lambda expressions: 'r -> r.getRoomNum() == roomNum'\\n  * Creating custom interfaces: 'interface RoomCondition { boolean test(HotelRoom room); }'\\n  * Passing interfaces as parameters: 'getRoomByCondition(a, b, c, condition)'\\n  * Methods that require array indexing with [i] or iteration patterns\\n  * Any solution that requires defining new interfaces or using functional programming concepts\\n  These solutions are NOT ACCEPTABLE because students haven't learned these concepts yet.\\n- VALID SOLUTIONS: Only suggest extracting duplicate code into simple helper methods that use basic Java features (loops, conditionals, method parameters with primitive types, Strings, or existing classes) AND that result in fewer total lines of code\\n\\nIF DUPLICATE CODE IS FOUND:\\n- Include âŒ Duplicate Code (-10 points)\\n- Name the methods containing the duplicated logic\\n- Provide the COMPLETE solution: method signature AND implementation in a code block\\n- Show exactly how the duplicated logic should be extracted\\n- DO NOT mention code that is already correct\\n- Ensure your solution uses ONLY basic Java features (no lambda, no functional interfaces, no array indexing, no advanced concepts)\\n- Verify that the extraction reduces total code lines\\n\\nMAGIC NUMBERS:\\n- DO NOT penalize magic numbers in the main function\\n- Penalize magic numbers used in constructors, setters, or getters\\n- Magic numbers must be replaced with named static final constants\\n- For magic numbers, only explain WHAT needs to change (no code solution)\\n\\nSCORING (ONLY IF APPLICABLE):\\n- âŒ Duplicate Code (-10 points)\\n- âŒ Magic Numbers (-5 points)\\n\\nNO ISSUES FOUND:\\n- Start with: âœ… Code Quality: Excellent!\\n- Then add a short compliment in Hebrew rooted in Jewish tradition or biblical language (e.g., praise for good work, diligence, or wisdom)\\n\\nIF PENALTIES APPLY:\\n- End with: Recommended adjusted grade: [original grade minus penalties]%\\n\\nWhen in doubt â€” DO NOT penalize.\\n\\nCode:\\n$ALL_CONTENT_ESCAPED\"}
                ],
                \"max_tokens\": 4000,
                \"store\": true
              }")

            # Check for API errors first
            ERROR_MSG=$(echo "$RAW_RESPONSE" | jq -r '.error.message // empty')
            if [ -n "$ERROR_MSG" ]; then
              echo "API Error: $ERROR_MSG"
              echo "Full response: $RAW_RESPONSE"
            fi

            # Extract the content
            RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // empty')

            # Check if response is not null or empty
            if [ -n "$RESPONSE" ]; then
              echo "API request successful"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "API response was null/empty. Retrying in 5 seconds... (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
            else
              echo "API request failed after $MAX_RETRIES attempts"
              RESPONSE="âš ï¸ **AI Review Unavailable** (-20 points): API request failed. Please check back later."
            fi
          done

          echo "## AI Code Review" > .github/badges/review.md
          echo "" >> .github/badges/review.md
          echo "$RESPONSE" >> .github/badges/review.md

          # Check for violations and update grade
          CODING_STANDARD_PENALTY=0
          DUPLICATE_CODE_PENALTY=0
          MAGIC_NUMBERS_PENALTY=0
          AI_REVIEW_UNAVAILABLE_PENALTY=0

          if grep -q "âš ï¸ \*\*AI Review Unavailable\*\*" .github/badges/review.md; then
            AI_REVIEW_UNAVAILABLE_PENALTY=20
          fi

          if grep -q "âŒ Duplicate Code" .github/badges/review.md; then
            DUPLICATE_CODE_PENALTY=10
          fi

          if grep -q "âŒ Magic Numbers" .github/badges/review.md; then
            MAGIC_NUMBERS_PENALTY=5
          fi

          TOTAL_PENALTY=$((CODING_STANDARD_PENALTY + DUPLICATE_CODE_PENALTY + MAGIC_NUMBERS_PENALTY + AI_REVIEW_UNAVAILABLE_PENALTY))


          if [ $TOTAL_PENALTY -gt 0 ]; then
            # Update grade badge with total penalty
            update_grade_badge "${{ steps.grade.outputs.grade }}" "$TOTAL_PENALTY" ""
          else
            # No penalties, adjusted grade equals original grade
            echo "adjusted_grade=${{ steps.grade.outputs.grade }}" >> $GITHUB_OUTPUT
          fi
      - name: GitHub Classroom Grader
        uses: baraksu-class-2026/manual-grading-command-grader@v1
        if: always()
        id: run-tests
        with:
          test-name: Junit And AI.
          score: ${{ steps.ai_review.outputs.adjusted_grade || steps.grade.outputs.grade }}
          max-score: 100
          pass-score: 85
      - name: Autograding Reporter
        if: always()
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          RUN-TESTS_RESULTS: "${{steps.run-tests.outputs.result}}"
        with:
          runners: run-tests
      # Update README with all badge contents (last step)
      - name: Update README with Badge
        if: always()
        run: |
          # Read the badge files content
          GRADE_CONTENT=$(cat .github/badges/grade.md)
          TEST_REPORT_CONTENT=$(cat .github/badges/test_report.md)

          # Check if review.md exists, if not create a default message
          if [ -f .github/badges/review.md ]; then
            REVIEW_CONTENT=$(cat .github/badges/review.md)
          else
            REVIEW_CONTENT=$'## AI Code Review\n\nâŒ **AI Hasn\'t Reviewed Your Work**\n\nYour submission was not sent for AI review because the basic requirements were not met.'
          fi

          # Create README with injected content
          cat > README.md << 'EOFMARKER'
          ## Grade

          EOFMARKER
          echo "$GRADE_CONTENT" >> README.md

          # Add Checkstyle status if it failed
          if [ "${{ steps.reviewdog.outcome }}" = "failure" ]; then
            REPO_NAME="${{ github.event.repository.name }}"
            OWNER="${{ github.repository_owner }}"
            RUN_ID="${{ github.run_id }}"
            CHECKSTYLE_REPORT_URL="https://github.com/${OWNER}/${REPO_NAME}/actions/runs/${RUN_ID}"
            cat >> README.md << 'EOFMARKER2'

          ## Coding Standards

          EOFMARKER2
            echo "âŒ **Coding Standard Failed (-25 points)** - [View Checkstyle Report](${CHECKSTYLE_REPORT_URL})" >> README.md
          fi

          cat >> README.md << 'EOFMARKER'

          ## Tests

          EOFMARKER
          echo "$TEST_REPORT_CONTENT" >> README.md

          cat >> README.md << 'EOFMARKER'

          EOFMARKER
          echo "$REVIEW_CONTENT" >> README.md
      # Commit and push all changes (final step)
      - name: Commit and Push All Changes
        if: always()
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Pull latest changes BEFORE staging to avoid conflicts
          git pull --rebase origin ${{ github.ref_name }} || echo "Already up to date"

          # Stage all changed files (only if they exist)
          for file in README.md .github/badges/grade.md .github/badges/test_report.md .github/badges/review.md; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done

          # Commit all changes
          git commit -m "Update README and badges [skip ci]" || echo "No changes to commit"

          # Push changes
          git push || echo "Nothing to push"
